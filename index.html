<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funding Rates 排序</title>
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/themes/prism.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/prism.js"></script>
    <style>
        body {
            display: flex;
            justify-content: space-between;
            margin: 20px;
        }
        #funding-rates-container {
            flex: 1;
        }
        .danger { color: red; font-weight: bold; }
        #funding-rates-content {
            display: none;
            white-space: pre-wrap;
            background-color: #f4f4f4;
            padding: 10px;
            border: 1px solid #ddd;
            margin-top: 20px;
            width: 45%;
            max-height: 80vh;
            overflow: auto;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="funding-rates-container">
        <h1>Funding Rates 排序</h1>
        <button onclick="showFundingRates()">顯示 CryptoTrading.js 內容</button>
        <p id="progress">已處理 0 / 0 筆</p>
        <ul id="funding-rates"></ul>
    </div>

    <pre id="funding-rates-content"><code class="language-javascript"></code></pre>

    <script>
        const proxyUrl = 'https://crimson-brook-7b64.siriuschurchill.workers.dev/api';
        const apiUrlTradingPairs = '/trading_pairs';
        const apiUrlFundingRate = '/funding_rate?symbol=';
        const dangerSymbols = ["HIVEUSDT", "MEUSDT", "GLMUSDT"];

        async function fetchTradingPairs() {
            try {
                const response = await fetch(proxyUrl + apiUrlTradingPairs);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                const data = await response.json();
                return data.data.map(pair => pair.symbol);
            } catch (error) {
                alert("請求失敗，請檢查 Cloudflare Workers 是否正常運作！");
                console.error(error);
                return [];
            }
        }

        async function fetchFundingRate(symbol, rates, progress) {
            try {
                const response = await fetch(proxyUrl + apiUrlFundingRate + symbol);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                const data = await response.json();
                const fundingRate = parseFloat(data.data.fundingRate);

                rates.push({ symbol, fundingRate });
                progress.completed++;

                updateDisplay(rates, progress);
            } catch (error) {
                console.error("請求錯誤:", error);
            }
        }

        function updateDisplay(rates, progress) {
            const progressContainer = document.getElementById('progress');
            const container = document.getElementById('funding-rates');

            progressContainer.textContent = `已處理 ${progress.completed} / ${progress.total} 筆`;

            container.innerHTML = rates
                .sort((a, b) => a.fundingRate - b.fundingRate)
                .map(rate => {
                    const isDanger = dangerSymbols.includes(rate.symbol);
                    return `<li class="${isDanger ? 'danger' : ''}">${rate.symbol}: ${rate.fundingRate}</li>`;
                })
                .join('');
        }

        async function displayFundingRates() {
            const symbols = await fetchTradingPairs();
            if (symbols.length === 0) return;

            const rates = [];
            const progress = { completed: 0, total: symbols.length };

            updateDisplay(rates, progress);

            for (const symbol of symbols) {
                fetchFundingRate(symbol, rates, progress);
            }
        }

        async function showFundingRates() {
            try {
                const response = await fetch('CryptoTrading.js');
                if (!response.ok) throw new Error(`無法載入 CryptoTrading.js: ${response.status}`);
                
                const jsCode = await response.text();
                document.getElementById('funding-rates-content').innerHTML = `<code class="language-javascript">${Prism.util.encode(jsCode)}</code>`;
                document.getElementById('funding-rates-content').style.display = 'block';

                Prism.highlightAll();
            } catch (error) {
                console.error("載入 CryptoTrading.js 錯誤:", error);
            }
        }

        document.addEventListener('DOMContentLoaded', displayFundingRates);
    </script>
</body>
</html>
