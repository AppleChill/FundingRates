<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funding Rates 排序</title>
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/themes/prism.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/prism.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/plugins/line-numbers/prism-line-numbers.css"
        rel="stylesheet" />
    <style>
        body {
            display: flex;
            margin: 20px;
            height: 100vh;
        }

        #funding-rates-container {
            flex: 1;
            overflow: auto;
        }

        .danger {
            color: red;
            font-weight: bold;
        }

        #funding-rates-content {
            display: none;
            position: relative;
            background-color: #f4f4f4;
            padding: 20px;
            border: 1px solid #ddd;
            width: 50%;
            height: 100vh;
            overflow-y: auto;
            border-radius: 5px;
        }

        pre {
            margin: 0;
            padding: 10px;
            overflow: auto;
            height: 100%;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .copy-btn:hover {
            opacity: 1;
        }

        .copy-btn::after {
            content: '📋 Copy';
            font-size: 14px;
            color: #333;
        }

        .copy-btn.copied::after {
            content: '✔ Copied';
            color: green;
        }
    </style>
</head>

<body>
    <div id="funding-rates-container">
        <h1>Funding Rates 排序</h1>
        <button onclick="toggleFundingRates()">顯示/隱藏 CryptoTrading.js 內容</button>
        <p id="progress">已處理 0 / 0 筆</p>
        <ul id="funding-rates"></ul>
    </div>

    <div id="funding-rates-content">
        <button class="copy-btn" onclick="copyContent()"></button>
        <pre class="line-numbers"><code class="language-javascript"></code></pre>
    </div>

    <script>
        const proxyUrl = 'https://crimson-brook-7b64.siriuschurchill.workers.dev/api';
        const apiUrlTradingPairs = '/trading_pairs';
        const apiUrlFundingRate = '/funding_rate?symbol=';
        const dangerSymbols = ["HIVEUSDT", "MEUSDT", "GLMUSDT"];

        async function fetchTradingPairs() {
            try {
                const response = await fetch(proxyUrl + apiUrlTradingPairs);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                const data = await response.json();
                return data.data.map(pair => pair.symbol);
            } catch (error) {
                alert("請求失敗，請檢查 Cloudflare Workers 是否正常運作！");
                console.error(error);
                return [];
            }
        }

        async function displayFundingRates() {
            const symbols = await fetchTradingPairs();
            if (symbols.length === 0) return;

            const rates = [];
            const progress = { completed: 0, total: symbols.length };

            updateDisplay(rates, progress);

            for (const symbol of symbols) {
                fetchFundingRate(symbol, rates, progress);
            }
        }

        async function fetchFundingRate(symbol, rates, progress) {
            try {
                const response = await fetch(proxyUrl + apiUrlFundingRate + symbol);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                const data = await response.json();
                const fundingRate = parseFloat(data.data.fundingRate);

                rates.push({ symbol, fundingRate });
                progress.completed++;

                updateDisplay(rates, progress);
            } catch (error) {
                console.error("請求錯誤:", error);
            }
        }

        function updateDisplay(rates, progress) {
            const progressContainer = document.getElementById('progress');
            const container = document.getElementById('funding-rates');

            progressContainer.textContent = `已處理 ${progress.completed} / ${progress.total} 筆`;

            container.innerHTML = rates
                .sort((a, b) => a.fundingRate - b.fundingRate)
                .map(rate => {
                    const isDanger = dangerSymbols.includes(rate.symbol);
                    return `<li class="${isDanger ? 'danger' : ''}">${rate.symbol}: ${rate.fundingRate}</li>`;
                })
                .join('');
        }

        async function toggleFundingRates() {
            const contentBlock = document.getElementById('funding-rates-content');
            if (contentBlock.style.display === 'block') {
                contentBlock.style.display = 'none';
                return;
            }
            try {
                // 更新路徑至 JavaScript/CryptoTrading.js
                const response = await fetch('JavaScript/CryptoTrading.js');
                if (!response.ok) throw new Error(`無法載入 CryptoTrading.js: ${response.status}`);

                const jsCode = await response.text();
                document.querySelector('#funding-rates-content code').textContent = jsCode;
                contentBlock.style.display = 'block';
                Prism.highlightAll();
            } catch (error) {
                console.error("載入 CryptoTrading.js 錯誤:", error);
            }
        }

        function copyContent() {
            const codeText = document.querySelector('#funding-rates-content code').innerText;
            navigator.clipboard.writeText(codeText).then(() => {
                const copyBtn = document.querySelector('.copy-btn');
                copyBtn.classList.add('copied');
                setTimeout(() => copyBtn.classList.remove('copied'), 1500);
            }).catch(err => console.error('複製失敗:', err));
        }

        document.addEventListener('DOMContentLoaded', displayFundingRates);
    </script>
</body>

</html>